{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "config": {
            "isWizard": false,
            "basics": {
                "description": "Deployment van een basis netwerk in Azure",
                "resourceGroup": {
                    "allowExisting": true
                },
                "location": {
                    "label": "Locatie voor de aan te maken resources",
                    "allowedValues": [
                        "westeurope"
                    ],
                    "visible": true
                }
            }
        },
        "basics": [
            {
                "name": "CustomerName",
                "type": "Microsoft.Common.TextBox",
                "label": "Bedrijfsnaam van de klant",
                "defaultValue": "",
                "constraints": {
                    "required": true
                }
            }
        ],
        "steps": [
{
                    "name": "networking",
                    "label": "VPN",
                    "bladeTitle": "lzGs",
                    "elements": [
                        {
                            "name": "vnetAddressSpace",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Address space (benodigd voor het virtuele netwerk)",
                            "toolTip": "Vul een CIDR adres range in (b.v 10.20.0.0/20)",
                            "defaultValue": "10.20.0.0/20",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(1[0-9]|2[0-4]))$",
                                        "message": "Ongeldige CIDR range. Prefix moet zich in de volgende range bevinden [10,24]."
                                    }
                                ]
                            }
                        },
                        {
                            "name": "addsAddressSpace",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Subnet voor AADDS",
                            "defaultValue": "10.20.0.0/24",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(2[4-9]))$",
                                        "message": "Ongeldige CIDR range. Prefix moet zich in de volgende range bevinden [24,27]."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 8), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 1)), last(take(split(first(split(steps('networking').addsAddressSpace, '/')), '.'), 1))), true)]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (eerste octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 16), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 2)), last(take(split(first(split(steps('networking').addsAddressSpace, '/')), '.'), 2))), true)]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (tweede octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 24), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 3)), last(take(split(first(split(steps('networking').addsAddressSpace, '/')), '.'), 3))), true)]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (derde octet)."
                                    },
                                    {
                                        "isValid": "[lessOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), last(split(steps('networking').addsAddressSpace, '/')))]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (subnet mask)."
                                    }
                                ]
                            }
                        },
                                                {
                            "name": "avdHostsAddressSpace",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Subnet voor AVD Hosts",
                            "toolTip": "Vul een CIDR adres range in (b.v 10.20.1.0/24)",
                            "defaultValue": "10.20.1.0/24",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(2[4-7]))$",
                                        "message": "Ongeldige CIDR range. Prefix moet zich in de volgende range bevinden [24,27]."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 8), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 1)), last(take(split(first(split(steps('networking').avdHostsAddressSpace, '/')), '.'), 1))), true)]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (eerste octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 16), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 2)), last(take(split(first(split(steps('networking').avdHostsAddressSpace, '/')), '.'), 2))), true)]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (tweede octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 24), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 3)), last(take(split(first(split(steps('networking').avdHostsAddressSpace, '/')), '.'), 3))), true)]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (derde octet)."
                                    },
                                    {
                                        "isValid": "[lessOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), last(split(steps('networking').avdHostsAddressSpace, '/')))]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (subnet mask)."
                                    }
                                ]
                            }
                        },
                        {
                            "name": "VpnGw",
                            "type": "Microsoft.Common.OptionsGroup",
                            "label": "Deploy VPN Gateway",
                            "defaultValue": "Nee",
                            "constraints": {
                                "required": true,
                                "allowedValues": [
                                    {
                                        "label": "Ja",
                                        "value": "Yes"
                                    },
									{
										"label": "Nee",
										"value": "No"
									}
                                ]
                            },
                            "visible": true
                        },                        	
                        {
                            "name": "GwSku",
                            "type": "Microsoft.Common.DropDown",
                            "label": "Selecteer de VPN Gateway SKU",
                            "defaultValue": "VpnGw1",
                            "multiselect": false,
                            "selectAll": false,
                            "filter": false,
                            "multiLine": true,
                            "visible": "[not(equals(steps('networking').VpnGw,'No'))]",
                            "constraints": {
                                "required": true,
                                "allowedValues": [
                                    {
                                        "label": "Basic",
                                        "description": "Ondersteund geen BGP, max 10 S2S/VNet-VNet tunnels, max 128 P2S SSTP verbindingen, geen ondersteuning voor IKEv2/OpenVPN verbindingen, doorvoer is 100 Mbps",
                                        "value": "Basic"
                                    },
                                    {
                                        "label": "VpnGw1",
                                        "description": "Ondersteund BGP, max 30 S2S/VNet-VNet tunnels (waarvan 10 inbegrepen), max 128 P2S SSTP verbindingen, max 250 IKEv2/OpenVPN verbindingen, doorvoer is 650 Mbps",
                                        "value": "VpnGw1"
                                    },
                                    {
                                        "label": "VpnGw2",
                                        "description": "Ondersteund BGP, max 30 S2S/VNet-VNet tunnels (waarvan 10 inbegrepen), max 128 P2S SSTP verbindingen, max 500 IKEv2/OpenVPN verbindingen, doorvoer is 1 Gbps",
                                        "value": "VpnGw2"
                                    },
                                    {
                                        "label": "VpnGw3",
                                        "description": "Ondersteund BGP, max 30 S2S/VNet-VNet tunnels (waarvan 10 inbegrepen), max 128 P2S SSTP verbindingen, max 1000 IKEv2/OpenVPN verbindingen, doorvoer is 1,25 Gbps",
                                        "value": "VpnGw3"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "vpnAddressSpace",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Subnet voor VPN Gateways",
                            "toolTip": "Vul een CIDR adres range in (b.v 10.20.2.0/24)",
                            "defaultValue": "10.20.2.0/24",
                            "visible": "[not(equals(steps('networking').VpnGw,'No'))]",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(2[4-7]))$",
                                        "message": "Ongeldige CIDR range. Prefix moet zich in de volgende range bevinden [24,27]."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 8), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 1)), last(take(split(first(split(steps('networking').vpnAddressSpace, '/')), '.'), 1))), true)]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (eerste octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 16), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 2)), last(take(split(first(split(steps('networking').vpnAddressSpace, '/')), '.'), 2))), true)]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (tweede octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 24), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 3)), last(take(split(first(split(steps('networking').vpnAddressSpace, '/')), '.'), 3))), true)]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (derde octet)."
                                    },
                                    {
                                        "isValid": "[lessOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), last(split(steps('networking').vpnAddressSpace, '/')))]",
                                        "message": "CIDR range valt niet binnen het bereik van het virtuele netwerk (subnet mask)."
                                    }
                                ]
                            }
                        },
                        {
                            "name": "createConnection",
                            "type": "Microsoft.Common.OptionsGroup",
                            "label": "Alvast de eerste VPN verbinding opgeven?",
                            "defaultValue": "Nee",
                            "visible": "[not(equals(steps('networking').VpnGw,'No'))]",
                            "constraints": {
                                "required": true,
                                "allowedValues": [
                                    {
                                        "label": "Ja",
                                        "value": "Yes"
                                    },
									{
										"label": "Nee",
										"value": "No"
									}
                                ]
                            }
                        },
                        {
                            "name": "connectionCity",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Vul de plaatsnaam in",
                            "toolTip": "Vul de plaatsnaam in van de locatie waar de router staat",
                            "defaultValue": "Groningen",
                            "visible": "[and(not(equals(steps('networking').createConnection,'No')), not(equals(steps('networking').VpnGw,'No')))]",
                            "constraints": {
                                "required": true
                            }
                        },
                        {
                            "name": "connectionZipCode",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Vul de postcode",
                            "toolTip": "Vul de postcode in van locatie waar de router staat",
                            "defaultValue": "9723JA",
                            "visible": "[and(not(equals(steps('networking').createConnection,'No')), not(equals(steps('networking').VpnGw,'No')))]",
                            "constraints": {
                                "required": true
                            }
                        },
                        {
                            "name": "localGatewayIP",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Vul het WAN adres in",
                            "toolTip": "Vul het WAN adres in van de router waar verbinding mee word gemaakt",
                            "defaultValue": "212.78.220.238",
                            "visible": "[and(not(equals(steps('networking').createConnection,'No')), not(equals(steps('networking').VpnGw,'No')))]",
                            "constraints": {
                                "required": true
                            }
                        },
                        {
                            "name": "localGatewayAddressSpace",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Lokale CIDR range",
                            "toolTip": "Vul de lokale CIDR range in",
                            "defaultValue": "10.75.1.0/24",
                            "visible": "[and(not(equals(steps('networking').createConnection,'No')), not(equals(steps('networking').VpnGw,'No')))]",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(1[0-9]|2[0-4]))$",
                                        "message": "Ongeldige CIDR range. Prefix moet zich in de volgende range bevinden [10,24]."
                                    }
                                ]
                            }
                        },
                        {
                            "name": "connectionPSK",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Vul de PSK in",
                            "toolTip": "Vul de Pre Shared Key in voor de VPN verbinding",
                            "defaultValue": "PSK",
                            "visible": "[and(not(equals(steps('networking').createConnection,'No')), not(equals(steps('networking').VpnGw,'No')))]",
                            "constraints": {
                                "required": true
                            }
                        }       
                    ]
                
            
            },
            {
                "name": "tags",
                "label": "Tags",
                "elements": [
                    {
                        "name": "tagsByResource",
                        "type": "Microsoft.Common.TagsByResource",
                        "resources": [
                            "Microsoft.Storage/storageAccounts",
                            "Microsoft.Compute/virtualMachines",
                            "Microsoft.Network/virtualNetworkGateways",
                            "Microsoft.Network/localNetworkGateways",
                            "Microsoft.Network/connections",
                            "Microsoft.Network/publicIPAddresses",
                            "microsoft.network/virtualnetworks"
                        ]
                    }
                ]
            }
        ],
        "outputs": {
            "CustomerName": "[basics('CustomerName')]",
            "VNet-addressSpace": "[steps('networking').vnetAddressSpace]",
            "ADDS-AddressSpace": "[steps('networking').addsAddressSpace]",
            "AVD-AddressSpace": "[steps('networking').avdHostsAddressSpace]",
            "GatewaySubnet-AddressSpace": "[steps('networking').vpnAddressSpace]",
            "ipsecPSK": "[steps('networking').connectionPSK]",
            "CustomerCity": "[steps('networking').connectionCity]",
            "CustomerZipCode": "[steps('networking').connectionZipCode]",
            "localGatewayIP": "[steps('networking').localGatewayIP]",
            "localNetworkAddressRange": "[steps('networking').localGatewayAddressSpace]",
            "deployVPN": "[steps('networking').VpnGw]",
            "createConnection": "[steps('networking').createConnection]",
            "gatewaySku": "[steps('networking').GwSku]"
        }
    }
}
