{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "config": {
            "isWizard": false,
            "basics": {
                "description": "Deployment of basic resources in Azure",
                "resourceGroup": {
                    "allowExisting": true
                },
                "location": {
                    "label": "Location for the resources to be deployed in",
                    "allowedValues": [
                        "westeurope"
                    ],
                    "visible": true
                }
            }
        },
        "basics": [
            {
                "name": "CustomerName",
                "type": "Microsoft.Common.TextBox",
                "label": "Enter custommer name",
                "defaultValue": "",
                "constraints": {
                    "required": true,
                    "regex": "^[a-z0-9]{1,10}$",
                    "validationMessage": "The custommer name has te be between 1 and 10 charactars long and contain only numbers and non capital letters."
                }
            }
        ],
        "steps":[
                {
                    "name": "networking",
                    "label": "Network",
                    "bladeTitle": "lzGs",
                    "elements": [
                        {
                            "name": "vnetAddressSpace",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Address space (Needed for the virtual network)",
                            "toolTip": "Enter a CIDR range (for example 10.20.0.0/20)",
                            "defaultValue": "10.20.0.0/20",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(1[0-9]|2[0-4]))$",
                                        "message": "Invalid CIDR range. Prefix has to be within this range [10,24]."
                                    }
                                ]
                            }
                        },
                        {
                            "name": "addsAddressSpace",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Subnet for AADDS",
                            "defaultValue": "10.20.0.0/24",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(2[4-9]))$",
                                        "message": "Invalid CIDR range. Prefix has to be within this range [24,27]."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 8), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 1)), last(take(split(first(split(steps('networking').addsAddressSpace, '/')), '.'), 1))), true)]",
                                        "message": "CIDR range is not within the scope of the virtual network (fiurst octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 16), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 2)), last(take(split(first(split(steps('networking').addsAddressSpace, '/')), '.'), 2))), true)]",
                                        "message": "CIDR range is not within the scope of the virtual network (second octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 24), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 3)), last(take(split(first(split(steps('networking').addsAddressSpace, '/')), '.'), 3))), true)]",
                                        "message": "CIDR range is not within the scope of the virtual network (third octet)."
                                    },
                                    {
                                        "isValid": "[lessOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), last(split(steps('networking').addsAddressSpace, '/')))]",
                                        "message": "CIDR range is not within the scope of the virtual network (subnet mask)."
                                    }
                                ]
                            }
                        },
                                                {
                            "name": "avdHostsAddressSpace",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Subnet for AVD Hosts",
                            "toolTip": "Enter a CIDR range (for example 10.20.1.0/24)",
                            "defaultValue": "10.20.1.0/24",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(2[4-7]))$",
                                        "message": "Invalid CIDR range. Prefix has to be within this range [24,27]."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 8), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 1)), last(take(split(first(split(steps('networking').avdHostsAddressSpace, '/')), '.'), 1))), true)]",
                                        "message": "CIDR range is not within the scope of the virtual network (first octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 16), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 2)), last(take(split(first(split(steps('networking').avdHostsAddressSpace, '/')), '.'), 2))), true)]",
                                        "message": "CIDR range is not within the scope of the virtual network (second octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 24), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 3)), last(take(split(first(split(steps('networking').avdHostsAddressSpace, '/')), '.'), 3))), true)]",
                                        "message": "CIDR range is not within the scope of the virtual network (third octet)."
                                    },
                                    {
                                        "isValid": "[lessOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), last(split(steps('networking').avdHostsAddressSpace, '/')))]",
                                        "message": "CIDR range is not within the scope of the virtual network (subnet mask)."
                                    }
                                ]
                            }
                        },
                        {
                            "name": "VpnGw",
                            "type": "Microsoft.Common.OptionsGroup",
                            "label": "Deploy VPN Gateway",
                            "defaultValue": "No",
                            "constraints": {
                                "required": true,
                                "allowedValues": [
                                    {
                                        "label": "Yes",
                                        "value": "Yes"
                                    },
									{
										"label": "No",
										"value": "No"
									}
                                ]
                            },
                            "visible": true
                        },                        	
                        {
                            "name": "GwSku",
                            "type": "Microsoft.Common.DropDown",
                            "label": "Select VPN Gateway SKU",
                            "defaultValue": "VpnGw1",
                            "multiselect": false,
                            "selectAll": false,
                            "filter": false,
                            "multiLine": true,
                            "visible": "[not(equals(steps('networking').VpnGw,'No'))]",
                            "constraints": {
                                "required": true,
                                "allowedValues": [
                                    {
                                        "label": "Basic",
                                        "description": "Doesn't support BGP, max 10 S2S/VNet-VNet tunnels, max 128 P2S SSTP connections, no support fpr IKEv2/OpenVPN connections, aggregate throughput is 100 Mbps",
                                        "value": "Basic"
                                    },
                                    {
                                        "label": "VpnGw1",
                                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels (of which 10 are included), max 128 P2S SSTP connections, max 250 IKEv2/OpenVPN connections, aggregate throughput is 650 Mbps",
                                        "value": "VpnGw1"
                                    },
                                    {
                                        "label": "VpnGw2",
                                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels (of which 10 are included), max 128 P2S SSTP connections, max 500 IKEv2/OpenVPN connections, aggregate throughput is 1 Gbps",
                                        "value": "VpnGw2"
                                    },
                                    {
                                        "label": "VpnGw3",
                                        "description": "Supports BGP, max 30 S2S/VNet-VNet tunnels (of which 10 are included), max 128 P2S SSTP connections, max 1000 IKEv2/OpenVPN connections, aggregate throughput is 1,25 Gbps",
                                        "value": "VpnGw3"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "vpnAddressSpace",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Subnet for VPN Gateways",
                            "toolTip": "Enter a CIDR range (for example 10.20.2.0/24)",
                            "defaultValue": "10.20.2.0/24",
                            "visible": "[not(equals(steps('networking').VpnGw,'No'))]",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(2[4-7]))$",
                                        "message": "Invalid CIDR range. Prefix has to be within this range [24,27]."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 8), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 1)), last(take(split(first(split(steps('networking').vpnAddressSpace, '/')), '.'), 1))), true)]",
                                        "message": "CIDR range is not within the scope of the virtual network (first octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 16), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 2)), last(take(split(first(split(steps('networking').vpnAddressSpace, '/')), '.'), 2))), true)]",
                                        "message": "CIDR range is not within the scope of the virtual network (second octet)."
                                    },
                                    {
                                        "isValid": "[if(greaterOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), 24), equals(last(take(split(first(split(steps('networking').vnetAddressSpace, '/')), '.'), 3)), last(take(split(first(split(steps('networking').vpnAddressSpace, '/')), '.'), 3))), true)]",
                                        "message": "CIDR range is not within the scope of the virtual network (third octet)."
                                    },
                                    {
                                        "isValid": "[lessOrEquals(last(split(steps('networking').vnetAddressSpace, '/')), last(split(steps('networking').vpnAddressSpace, '/')))]",
                                        "message": "CIDR range is not within the scope of the virtual network (subnet mask)."
                                    }
                                ]
                            }
                        },
                        {
                            "name": "createConnection",
                            "type": "Microsoft.Common.OptionsGroup",
                            "label": "Enter values for the first Site to Site connection?",
                            "defaultValue": "No",
                            "visible": "[not(equals(steps('networking').VpnGw,'No'))]",
                            "constraints": {
                                "required": true,
                                "allowedValues": [
                                    {
                                        "label": "Yes",
                                        "value": "Yes"
                                    },
									{
										"label": "No",
										"value": "No"
									}
                                ]
                            }
                        },
                        {
                            "name": "connectionCity",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Enter the city",
                            "toolTip": "Enter the city where the remote gateway is located",
                            "defaultValue": "ExampleCity",
                            "visible": "[and(not(equals(steps('networking').createConnection,'No')), not(equals(steps('networking').VpnGw,'No')))]",
                            "constraints": {
                                "required": true
                            }
                        },
                        {
                            "name": "connectionZipCode",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Enter ZIP code",
                            "toolTip": "Enter the zip code where the remote gateway is located",
                            "defaultValue": "9723JA",
                            "visible": "[and(not(equals(steps('networking').createConnection,'No')), not(equals(steps('networking').VpnGw,'No')))]",
                            "constraints": {
                                "required": true,
                                "regex": "^[1-9][0-9]{3}(?!sa|sd|ss|SA|SD|SS)[A-Z]{2}$",
                                "validationMessage": "Zip code has te be in the following format: 1234AB"
                            }
                        },
                        {
                            "name": "localGatewayIP",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Enter WAN IP",
                            "toolTip": "Enter the WAN IP to which Azure has to connect",
                            "defaultValue": "8.8.8.8",
                            "visible": "[and(not(equals(steps('networking').createConnection,'No')), not(equals(steps('networking').VpnGw,'No')))]",
                            "constraints": {
                                "required": true
                            }
                        },
                        {
                            "name": "localGatewayAddressSpace",
                            "type": "Microsoft.Common.TextBox",
                            "label": "local CIDR range",
                            "toolTip": "Vul de lokale CIDR range in",
                            "defaultValue": "192.168.1.0/24",
                            "visible": "[and(not(equals(steps('networking').createConnection,'No')), not(equals(steps('networking').VpnGw,'No')))]",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(1[0-9]|2[0-4]))$",
                                        "message": "Invalid CIDR range. Prefix has to be within this range [10,24]."
                                    }
                                ]
                            }
                        },
                        {
                            "name": "connectionPSK",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Enter PSK",
                            "toolTip": "Enter the Pre Shared Key to setup the VPN",
                            "defaultValue": "PSK",
                            "visible": "[and(not(equals(steps('networking').createConnection,'No')), not(equals(steps('networking').VpnGw,'No')))]",
                            "constraints": {
                                "required": true
                            }
                        }       
                    ]       
            
            },
            {
                "name": "storage",
                "label": "Storage",
                "elements": [
                    {
                        "name": "fslogixShareSize",
                        "type": "Microsoft.Common.TextBox",
                        "label": "FSLogix Share Capacity in Gigabytes",
                        "defaultValue": 100,
                        "toolTip": "Enter FSlogix file share size, minimum is 100GB",
                        "constraints": {
                            "validations": [
                                {
                                    "regex": "^((102400)|(102[0-3][0-9]{2})|(10[0-1][0-9]{3})|([1-9][0-9]{4})|([1-9][0-9]{3})|([1-9][0-9]{2}))$",
                                    "message": "Enter a value from 100 to 102400."
                                }
                            ],
                            "required": true
                        },
                        "visible": true
                    },
                    {
                        "name": "isShareSoftDeleteEnabled",
                        "type": "Microsoft.Common.OptionsGroup",
                        "label": "Enable Soft Delete",
                        "defaultValue": "No",
                        "toolTip": "",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Yes",
                                    "value": true
                                },
                                {
                                    "label": "No",
                                    "value": false
                                }
                            ],
                            "required": true
                        },
                        "visible": true
                    },
                    {
                        "name": "shareSoftDeleteRetentionDays",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Soft Delete Retention Days",
                        "defaultValue": 7,
                        "toolTip": "Enter amount of days before deleted files are actually deleted",
                        "constraints": {
                            "validations": [
                                {
                                    "regex": "^((36[0-5])|(3[0-5][0-9]{1})|([1-2][0-9]{2})|([1-9][0-9]{1})|([1-9]))$",
                                    "message": "Vul een waarde in tussen 1 en 365."
                                }
                            ],
                            "required": true
                        },
                        "visible": "[not(equals(steps('storage').isShareSoftDeleteEnabled, false ))]"
                    }
                ]
            }
        ],
        "outputs": {
            "CustomerName": "[basics('CustomerName')]",
            "VNet-addressSpace": "[steps('networking').vnetAddressSpace]",
            "ADDS-AddressSpace": "[steps('networking').addsAddressSpace]",
            "AVD-AddressSpace": "[steps('networking').avdHostsAddressSpace]",
            "GatewaySubnet-AddressSpace": "[steps('networking').vpnAddressSpace]",
            "ipsecPSK": "[steps('networking').connectionPSK]",
            "CustomerCity": "[steps('networking').connectionCity]",
            "CustomerZipCode": "[steps('networking').connectionZipCode]",
            "localGatewayIP": "[steps('networking').localGatewayIP]",
            "localNetworkAddressRange": "[steps('networking').localGatewayAddressSpace]",
            "deployVPN": "[steps('networking').VpnGw]",
            "createConnection": "[steps('networking').createConnection]",
            "gatewaySku": "[steps('networking').GwSku]",
            "fslogixShareSize": "[steps('storage').fslogixShareSize]",
            "isShareSoftDeleteEnabled": "[steps('storage').isShareSoftDeleteEnabled]",
            "shareSoftDeleteRetentionDays": "[steps('storage').shareSoftDeleteRetentionDays]"
        }
    }
}