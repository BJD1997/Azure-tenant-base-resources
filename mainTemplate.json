{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "CustomerName": {
            "type": "string",
            "defaultValue": "klantnaam",
            "maxLength": 10,
            "metadata": {
                "description": "Vul de naam van de klant t.b.v naamschema"
            }
        },
        "VNet-addressSpace": {
            "type": "string",
            "defaultValue": "10.20.0.0/20",
            "metadata": {
                "description": "Virtueel netwerk (CIDR notatie)"
            }
        },
        "ADDS-AddressSpace": {
            "type": "string",
            "defaultValue": "10.20.0.0/24",
            "metadata": {
                "description": "AADDS Subnet (CIDR notatie)"
            }
        },
        "AVD-AddressSpace": {
            "type": "string",
            "defaultValue": "10.20.1.0/24",
            "metadata": {
                "description": "AVD Subnet (CIDR notatie)"
            }
        },
        "GatewaySubnet-AddressSpace": {
            "type": "string",
            "defaultValue": "10.20.2.0/24",
            "metadata": {
                "description": "Gateway Subnet (CIDR notatie)"
            }
        },
        "ipsecPSK": {
            "type": "string",
            "defaultValue": "sharedPSK",
            "metadata": {
                "description": "PSK voor de VPN connectie"
            }
        },
        "CustomerCity": {
            "type": "string",
            "defaultValue": "plaatsnaam",
            "metadata": {
                "description": "plaatsnaam voor de VPN connectie"
            }
        },
        "CustomerZipCode": {
            "type": "string",
            "defaultValue": "postcode",
            "metadata": {
                "description": "postcode voor de VPN connectie" 
            }
        },
        "localGatewayIP": {
            "type": "string",
            "defaultValue": "127.0.0.1",
            "metadata": {
                "description": "WAN IP van lokale router"
            }
        },
        "localNetworkAddressRange": {
            "type": "string",
            "defaultValue": "127.0.0.1/24",
            "metadata": {
                "description": "Lokale IP Reeks"
            }
        },
        "deployVPN": {
            "type": "string",
            "defaultValue": "No",
            "allowedValues": [
                "Yes",
                "No"
            ]
        },
        "createConnection": {
            "type": "string",
            "defaultValue": "No",
            "allowedValues": [
                "Yes",
                "No"
            ]
        },
        "gatewaySku": {
            "type": "string",
            "defaultValue": "VpnGw1",
            "allowedValues": [
                "Basic",
                "VpnGw1",
                "VpnGw2",
                "VpnGw3"
            ]
        }
    },
    "functions": [],
    "variables": {
        "vnetName": "[concat(parameters('CustomerName'), '-vnet-01')]",
        "storageName": "[concat(parameters('CustomerName'), 'stor')]",
        "firstSubnetName": "aadds",
        "secondSubnetName": "wvd-hosts",
        "GatewaySubnetName": "GatewaySubnet",
        "VPNGatewayPip": "[concat(parameters('CustomerName'), '-vgw-pip-01')]",
        "VPNGatewayName": "[concat(parameters('CustomerName'), '-vgw-01')]",
        "vpnVnetConnectionName": "[concat(parameters('CustomerName'), '-cn-', parameters('CustomerCity'), '-', parameters('CustomerZipCode'))]",
        "localNetworkGateway": "[concat(parameters('CustomerName'), '-lgw-', parameters('CustomerCity'), '-', parameters('CustomerZipCode'))]"
    },
    "resources": [
        {
            "name": "[variables('storageName')]",
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2021-04-01",
            "tags": {
                "displayName": "[variables('storageName')]"
            },
            "location": "[resourceGroup().location]",
            "kind": "FileStorage",
            "sku": {
                "name": "Premium_LRS",
                "tier": "Premium"
            }
        },
        {
            "condition": "[and(not(equals(parameters('deployVPN'),'Yes')),not(equals(parameters('createConnection'),'Yes')))]",
            "name": "networkOnly",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/BJD1997/DeployAzureNetworkWithGatewayandStorage/main/networkOnly.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vnetName": {
                        "value": "[variables('vnetName')]"
                    },
                    "VNet-addressSpace": {
                        "value": "[parameters('VNet-addressSpace')]"
                    },
                    "ADDS-AddressSpace": {
                        "value": "[parameters('ADDS-AddressSpace')]"
                    },
                    "AVD-AddressSpace": {
                        "value": "[parameters('AVD-AddressSpace')]"
                    },
                    "firstSubnetName": {
                        "value": "[variables('firstSubnetName')]"
                    },
                    "secondSubnetName": {
                        "value": "[variables('secondSubnetName')]"
                    }
                }
            }
        },
        {
            "condition": "[and(not(equals(parameters('deployVPN'),'No')),not(equals(parameters('createConnection'),'Yes')))]",
            "name": "networkAndGateway",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/BJD1997/DeployAzureNetworkWithGatewayandStorage/main/networkAndGateway.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vnetName": {
                        "value": "[variables('vnetName')]"
                    },
                    "VNet-addressSpace": {
                        "value": "[parameters('VNet-addressSpace')]"
                    },
                    "ADDS-AddressSpace": {
                        "value": "[parameters('ADDS-AddressSpace')]"
                    },
                    "AVD-AddressSpace": {
                        "value": "[parameters('AVD-AddressSpace')]"
                    },
                    "firstSubnetName": {
                        "value": "[variables('firstSubnetName')]"
                    },
                    "secondSubnetName": {
                        "value": "[variables('secondSubnetName')]"
                    },
                    "GatewaySubnetName": {
                        "value": "[variables('GatewaySubnetName')]"
                    },
                    "GatewaySubnet-AddressSpace": {
                        "value": "[parameters('GatewaySubnet-AddressSpace')]"
                    },
                    "VPNGatewayPip": {
                        "value": "[variables('VPNGatewayPip')]"
                    },
                    "VPNGatewayName": {
                        "value": "[variables('VPNGatewayName')]" 
                    },
                    "gatewaySku": {
                        "value": "[parameters('gatewaySku')]"
                    }
                }
            }
        },
        {
            "condition": "[and(not(equals(parameters('deployVPN'),'No')),not(equals(parameters('createConnection'),'No')))]",
            "name": "networkGatewayAndConnection",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/BJD1997/DeployAzureNetworkWithGatewayandStorage/main/networkGatewayAndConnection.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vnetName": {
                        "value": "[variables('vnetName')]"
                    },
                    "VNet-addressSpace": {
                        "value": "[parameters('VNet-addressSpace')]"
                    },
                    "ADDS-AddressSpace": {
                        "value": "[parameters('ADDS-AddressSpace')]"
                    },
                    "AVD-AddressSpace": {
                        "value": "[parameters('AVD-AddressSpace')]"
                    },
                    "firstSubnetName": {
                        "value": "[variables('firstSubnetName')]"
                    },
                    "secondSubnetName": {
                        "value": "[variables('secondSubnetName')]"
                    },
                    "GatewaySubnetName": {
                        "value": "[variables('GatewaySubnetName')]"
                    },
                    "GatewaySubnet-AddressSpace": {
                        "value": "[parameters('GatewaySubnet-AddressSpace')]"
                    },
                    "VPNGatewayPip": {
                        "value": "[variables('VPNGatewayPip')]"
                    },
                    "VPNGatewayName": {
                        "value": "[variables('VPNGatewayName')]" 
                    },
                    "gatewaySku": {
                        "value": "[parameters('gatewaySku')]"
                    },
                    "localNetworkGateway": {
                        "value": "[variables('localNetworkGateway')]"
                    },
                    "localNetworkAddressRange": {
                        "value": "[parameters('localNetworkAddressRange')]"
                    },
                    "localGatewayIP": {
                        "value": "[parameters('localGatewayIP')]"
                    },
                    "vpnVnetConnectionName": {
                        "value": "[variables('vpnVnetConnectionName')]"
                    },
                    "ipsecPSK": {
                        "value": "[parameters('ipsecPSK')]"
                    }
                }
            }
        }                   
    ],
    "outputs": {}
}
